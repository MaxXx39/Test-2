<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MapApp - Clone Google Maps</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- FontAwesome pour les icônes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body, html { height: 100%; margin: 0; overflow: hidden; }
        #map { height: 100%; width: 100%; z-index: 0; }
        
        /* Custom Scrollbar pour la liste de résultats */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Animation du loader */
        .loader {
            border-top-color: #3B82F6;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Style des marqueurs custom */
        .custom-pin {
            background-color: #EF4444;
            border: 2px solid white;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .user-pin {
            background-color: #3B82F6;
            border: 2px solid white;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <!-- Container Principal -->
    <div class="relative h-full w-full flex flex-col">

        <!-- Barre de Recherche Flottante -->
        <div class="absolute top-4 left-4 right-4 md:left-6 md:w-96 z-[1000]">
            <div class="bg-white rounded-lg shadow-xl flex items-center p-1 border border-gray-200">
                <div class="p-3 text-gray-400">
                    <i class="fas fa-search"></i>
                </div>
                <input 
                    type="text" 
                    id="searchInput" 
                    placeholder="Rechercher ici (ex: Tour Eiffel)..." 
                    class="flex-grow p-2 outline-none text-gray-700 font-medium"
                    autocomplete="off"
                >
                <div id="searchLoader" class="hidden p-3">
                    <div class="loader ease-linear rounded-full border-2 border-t-2 border-gray-200 h-5 w-5"></div>
                </div>
                <button id="clearBtn" class="hidden p-3 text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
                <div class="h-8 w-[1px] bg-gray-200 mx-1"></div>
                <button onclick="locateUser()" class="p-3 text-blue-500 hover:bg-blue-50 rounded-full transition" title="Ma position">
                    <i class="fas fa-location-arrow"></i>
                </button>
            </div>

            <!-- Résultats de recherche -->
            <div id="searchResults" class="hidden mt-2 bg-white rounded-lg shadow-xl overflow-hidden max-h-60 overflow-y-auto border border-gray-200">
                <!-- Les résultats seront injectés ici par JS -->
            </div>
        </div>

        <!-- Boutons d'action en bas à droite -->
        <div class="absolute bottom-8 right-4 z-[1000] flex flex-col gap-3">
            <button onclick="map.zoomIn()" class="bg-white p-3 rounded-full shadow-lg text-gray-600 hover:text-black hover:bg-gray-50 w-12 h-12 flex items-center justify-center transition">
                <i class="fas fa-plus"></i>
            </button>
            <button onclick="map.zoomOut()" class="bg-white p-3 rounded-full shadow-lg text-gray-600 hover:text-black hover:bg-gray-50 w-12 h-12 flex items-center justify-center transition">
                <i class="fas fa-minus"></i>
            </button>
            <button onclick="toggleLayer()" class="bg-white p-3 rounded-full shadow-lg text-gray-600 hover:text-black hover:bg-gray-50 w-12 h-12 flex items-center justify-center transition mt-2" title="Changer de vue">
                <i class="fas fa-layer-group"></i>
            </button>
        </div>

        <!-- La Carte -->
        <div id="map"></div>

        <!-- Modal d'info (Toast) -->
        <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-2xl z-[2000] transition-opacity duration-300 opacity-0 pointer-events-none text-sm font-medium flex items-center gap-2">
            <i class="fas fa-info-circle"></i>
            <span id="toastMsg">Message</span>
        </div>

    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // --- Configuration Initiale ---
        // Coordonnées par défaut (Paris)
        const defaultCoords = [48.8566, 2.3522];
        let currentMarker = null;
        let userMarker = null;
        let isSatellite = false;

        // Initialisation de la carte
        const map = L.map('map', {
            zoomControl: false // On crée nos propres boutons
        }).setView(defaultCoords, 13);

        // Couches de tuiles (Maps)
        const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        });

        const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri'
        });

        streetLayer.addTo(map);

        // --- Fonctions Utilitaires ---

        // Icône personnalisée HTML pour éviter les problèmes d'images 404
        function createCustomIcon(type) {
            return L.divIcon({
                className: 'custom-div-icon',
                html: `<div class="${type === 'user' ? 'user-pin' : 'custom-pin'} w-8 h-8 flex items-center justify-center shadow-lg rounded-full">
                        <i class="fas ${type === 'user' ? 'fa-user' : 'fa-map-marker-alt'} text-sm"></i>
                       </div>`,
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -36]
            });
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            const msg = document.getElementById('toastMsg');
            msg.innerText = message;
            toast.classList.remove('opacity-0', 'pointer-events-none');
            setTimeout(() => {
                toast.classList.add('opacity-0', 'pointer-events-none');
            }, 3000);
        }

        function toggleLayer() {
            isSatellite = !isSatellite;
            if (isSatellite) {
                map.removeLayer(streetLayer);
                satelliteLayer.addTo(map);
            } else {
                map.removeLayer(satelliteLayer);
                streetLayer.addTo(map);
            }
        }

        // --- Géolocalisation ---

        function locateUser() {
            showToast("Recherche de votre position...");
            
            map.locate({setView: true, maxZoom: 16});

            map.on('locationfound', function(e) {
                if (userMarker) {
                    map.removeLayer(userMarker);
                }
                
                userMarker = L.marker(e.latlng, { icon: createCustomIcon('user') }).addTo(map)
                    .bindPopup("Vous êtes ici").openPopup();
                
                L.circle(e.latlng, e.accuracy).addTo(map);
                showToast("Position trouvée !");
            });

            map.on('locationerror', function(e) {
                showToast("Impossible de vous localiser.");
            });
        }

        // --- Recherche (Nominatim API) ---

        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        const loader = document.getElementById('searchLoader');
        const clearBtn = document.getElementById('clearBtn');
        let debounceTimer;

        searchInput.addEventListener('input', (e) => {
            const query = e.target.value;
            
            // Gestion UI
            if (query.length > 0) {
                clearBtn.classList.remove('hidden');
            } else {
                clearBtn.classList.add('hidden');
                searchResults.classList.add('hidden');
                return;
            }

            // Debounce pour ne pas spammer l'API
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                performSearch(query);
            }, 500);
        });

        clearBtn.addEventListener('click', () => {
            searchInput.value = '';
            searchResults.classList.add('hidden');
            clearBtn.classList.add('hidden');
            searchInput.focus();
        });

        async function performSearch(query) {
            if (query.length < 3) return;

            loader.classList.remove('hidden');
            
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=5`);
                const data = await response.json();
                
                displayResults(data);
            } catch (error) {
                console.error("Erreur recherche:", error);
                showToast("Erreur lors de la recherche");
            } finally {
                loader.classList.add('hidden');
            }
        }

        function displayResults(data) {
            searchResults.innerHTML = '';
            
            if (data.length === 0) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'p-4 text-gray-500 text-sm text-center';
                emptyDiv.innerText = "Aucun résultat trouvé";
                searchResults.appendChild(emptyDiv);
            } else {
                data.forEach(place => {
                    const item = document.createElement('div');
                    item.className = 'p-3 border-b border-gray-100 hover:bg-blue-50 cursor-pointer transition flex items-start gap-3';
                    
                    // Icone selon le type
                    let iconClass = 'fa-map-marker-alt';
                    if (place.type === 'city' || place.type === 'administrative') iconClass = 'fa-city';
                    if (place.type === 'restaurant') iconClass = 'fa-utensils';
                    
                    item.innerHTML = `
                        <div class="mt-1 text-gray-400"><i class="fas ${iconClass}"></i></div>
                        <div>
                            <div class="font-medium text-gray-800 text-sm">${place.name || place.address.road || "Lieu inconnu"}</div>
                            <div class="text-xs text-gray-500 truncate w-64">${place.display_name}</div>
                        </div>
                    `;
                    
                    item.addEventListener('click', () => {
                        selectLocation(place);
                    });
                    
                    searchResults.appendChild(item);
                });
            }
            
            searchResults.classList.remove('hidden');
        }

        function selectLocation(place) {
            const lat = parseFloat(place.lat);
            const lon = parseFloat(place.lon);
            
            // Cacher la recherche
            searchResults.classList.add('hidden');
            searchInput.value = place.display_name.split(',')[0]; // Garder juste le nom principal
            
            // Déplacer la carte
            map.flyTo([lat, lon], 16);
            
            // Ajouter marqueur
            if (currentMarker) {
                map.removeLayer(currentMarker);
            }
            
            currentMarker = L.marker([lat, lon], { icon: createCustomIcon('pin') })
                .addTo(map)
                .bindPopup(`
                    <div class="text-center">
                        <strong class="block text-sm mb-1">${place.name || "Lieu sélectionné"}</strong>
                        <span class="text-xs text-gray-500 block">${place.type}</span>
                    </div>
                `)
                .openPopup();
        }

        // --- Interaction Carte (Clic) ---
        map.on('click', async function(e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;

            if (currentMarker) {
                map.removeLayer(currentMarker);
            }

            // Marqueur visuel immédiat
            currentMarker = L.marker([lat, lng], { icon: createCustomIcon('pin') }).addTo(map);

            // Reverse Geocoding (optionnel pour avoir l'adresse au clic)
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                const data = await response.json();
                
                const name = data.address.road || data.address.city || data.address.town || "Position marquée";
                
                currentMarker.bindPopup(`
                    <div class="text-center">
                        <strong class="block text-sm text-blue-600">${name}</strong>
                        <span class="text-xs text-gray-500">${lat.toFixed(5)}, ${lng.toFixed(5)}</span>
                    </div>
                `).openPopup();
                
            } catch(err) {
                currentMarker.bindPopup(`Position: ${lat.toFixed(4)}, ${lng.toFixed(4)}`).openPopup();
            }
        });

        // Fermer les résultats si on clique ailleurs
        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.classList.add('hidden');
            }
        });

    </script>
</body>
</html>
