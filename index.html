<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MapApp - Guide & Itinéraire</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    
    <!-- FontAwesome pour les icônes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body, html { height: 100%; margin: 0; overflow: hidden; }
        #map { height: 100%; width: 100%; z-index: 0; }
        
        /* Tweaks Leaflet Routing Machine pour le mobile */
        .leaflet-routing-container {
            background-color: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            max-height: 30vh; /* Limiter la hauteur sur mobile */
            overflow-y: auto;
            font-family: sans-serif;
            font-size: 12px;
            width: 300px;
        }
        /* Cacher le header par défaut du plugin qui est parfois gros */
        .leaflet-routing-container h2, .leaflet-routing-container h3 {
            font-size: 14px;
            margin-top: 0;
        }

        /* Custom Scrollbar */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* Loader */
        .loader {
            border-top-color: #3B82F6;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Marqueurs */
        .custom-pin {
            background-color: #EF4444;
            border: 2px solid white;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .user-pin {
            background-color: #3B82F6;
            border: 2px solid white;
        }

        /* Styles IA */
        .ai-content h3 { font-weight: 700; font-size: 1.1rem; margin-top: 1rem; color: #1e3a8a; }
        .ai-content p { margin-bottom: 0.5rem; color: #374151; }
        .ai-content ul { padding-left: 1.2rem; margin-bottom: 0.5rem; }
        
        /* Panel Animation */
        #aiPanel { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .panel-closed { transform: translateY(100%); }
        .panel-open { transform: translateY(0); }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div class="relative h-full w-full flex flex-col">

        <!-- Barre de Recherche -->
        <div class="absolute top-4 left-4 right-4 md:left-6 md:w-96 z-[1000]">
            <div class="bg-white rounded-lg shadow-xl flex items-center p-1 border border-gray-200">
                <div class="p-3 text-gray-400"><i class="fas fa-search"></i></div>
                <input type="text" id="searchInput" placeholder="Rechercher un lieu..." class="flex-grow p-2 outline-none text-gray-700 font-medium" autocomplete="off">
                <div id="searchLoader" class="hidden p-3">
                    <div class="loader ease-linear rounded-full border-2 border-t-2 border-gray-200 h-5 w-5"></div>
                </div>
                <button id="clearBtn" class="hidden p-3 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                <div class="h-8 w-[1px] bg-gray-200 mx-1"></div>
                <button onclick="locateUser()" class="p-3 text-blue-500 hover:bg-blue-50 rounded-full transition"><i class="fas fa-location-arrow"></i></button>
            </div>
            <div id="searchResults" class="hidden mt-2 bg-white rounded-lg shadow-xl overflow-hidden max-h-60 overflow-y-auto border border-gray-200"></div>
        </div>

        <!-- Boutons Actions (Bas Droite) -->
        <div class="absolute bottom-24 right-4 z-[1000] flex flex-col gap-3 items-end">
            
            <!-- Bouton Itinéraire (caché par défaut) -->
            <button id="routeBtn" onclick="startRoute()" class="hidden group flex items-center justify-center bg-green-500 text-white p-4 rounded-full shadow-lg hover:bg-green-600 hover:scale-105 transition-all duration-300 w-14 h-14 border-2 border-white z-[1010]">
                <i class="fas fa-directions text-2xl"></i>
                <span class="absolute right-16 bg-gray-900 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap">
                    Y aller
                </span>
            </button>

            <!-- Bouton IA -->
            <button onclick="askGeminiForGuide()" class="group relative flex items-center justify-center bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 text-white p-4 rounded-full shadow-lg hover:scale-105 transition-all duration-300 w-14 h-14 border-2 border-white z-[1010]">
                <i class="fas fa-sparkles text-xl"></i>
                <span class="absolute right-16 bg-gray-900 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap">
                    Guide IA
                </span>
            </button>

            <div class="flex flex-col gap-2 mt-2">
                <button onclick="map.zoomIn()" class="bg-white p-3 rounded-full shadow-lg text-gray-600 w-12 h-12 flex items-center justify-center"><i class="fas fa-plus"></i></button>
                <button onclick="map.zoomOut()" class="bg-white p-3 rounded-full shadow-lg text-gray-600 w-12 h-12 flex items-center justify-center"><i class="fas fa-minus"></i></button>
                <button onclick="toggleLayer()" class="bg-white p-3 rounded-full shadow-lg text-gray-600 w-12 h-12 flex items-center justify-center mt-2"><i class="fas fa-layer-group"></i></button>
            </div>
        </div>

        <!-- Panel IA -->
        <div id="aiPanel" class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl shadow-2xl z-[1100] panel-closed max-h-[80vh] flex flex-col md:w-[400px] md:left-auto md:right-6 md:bottom-6 md:rounded-2xl">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gradient-to-r from-indigo-50 to-purple-50 rounded-t-3xl md:rounded-t-2xl">
                <div class="flex items-center gap-2">
                    <i class="fas fa-robot text-purple-600"></i>
                    <span class="font-bold text-gray-800">Guide Local IA</span>
                </div>
                <button onclick="closeAiPanel()" class="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full"><i class="fas fa-times"></i></button>
            </div>
            <div class="overflow-y-auto p-5 flex-grow relative">
                <div id="aiLoader" class="hidden flex-col items-center justify-center py-8 text-center">
                    <div class="loader ease-linear rounded-full border-4 border-t-4 border-purple-200 h-10 w-10 mb-4" style="border-top-color: #8B5CF6;"></div>
                    <p class="text-purple-600 font-medium animate-pulse">Analyse en cours...</p>
                </div>
                <div id="aiResponse" class="ai-content text-sm hidden"></div>
                <div id="aiEmpty" class="flex flex-col items-center justify-center py-8 text-center text-gray-400">
                    <i class="fas fa-map-marked-alt text-4xl mb-3 text-gray-200"></i>
                    <p>Sélectionnez un lieu pour obtenir un guide.</p>
                </div>
            </div>
        </div>

        <div id="map"></div>
        
        <div id="toast" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-2xl z-[2000] transition-opacity duration-300 opacity-0 pointer-events-none text-sm font-medium flex items-center gap-2 whitespace-nowrap">
            <i class="fas fa-info-circle"></i><span id="toastMsg">Message</span>
        </div>
    </div>

    <!-- Leaflet & Plugins -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

    <script>
        // --- Config ---
        const apiKey = ""; 
        const defaultCoords = [48.8566, 2.3522];
        let currentMarker = null;
        let userMarker = null;
        let userLatLng = null;
        let routingControl = null;
        let isSatellite = false;
        let lastKnownLocationName = "Paris, France";

        // --- Map Init ---
        const map = L.map('map', { zoomControl: false }).setView(defaultCoords, 13);
        const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OSM contributors' });
        const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles © Esri' });
        streetLayer.addTo(map);

        // --- Icons ---
        function createCustomIcon(type) {
            return L.divIcon({
                className: 'custom-div-icon',
                html: `<div class="${type === 'user' ? 'user-pin' : 'custom-pin'} w-8 h-8 flex items-center justify-center shadow-lg rounded-full">
                        <i class="fas ${type === 'user' ? 'fa-user' : 'fa-map-marker-alt'} text-sm"></i>
                       </div>`,
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -36]
            });
        }

        // --- Routing Logic ---
        function startRoute() {
            if (!userLatLng) {
                showToast("Localisez-vous d'abord (bouton flèche en haut)");
                locateUser(); // Tentative auto
                return;
            }
            if (!currentMarker) {
                showToast("Sélectionnez une destination sur la carte");
                return;
            }

            // Nettoyer l'ancien itinéraire
            if (routingControl) {
                map.removeControl(routingControl);
            }

            const destLatLng = currentMarker.getLatLng();

            showToast("Calcul de l'itinéraire...");

            routingControl = L.Routing.control({
                waypoints: [
                    L.latLng(userLatLng.lat, userLatLng.lng),
                    L.latLng(destLatLng.lat, destLatLng.lng)
                ],
                routeWhileDragging: false,
                language: 'fr', // Instructions en français
                showAlternatives: false,
                fitSelectedRoutes: true,
                lineOptions: {
                    styles: [{color: '#3B82F6', opacity: 0.7, weight: 5}]
                },
                createMarker: function() { return null; } // On garde nos propres marqueurs
            }).addTo(map);

            // Gestion des erreurs de routing
            routingControl.on('routingerror', function(e) {
                showToast("Erreur : Impossible de calculer l'itinéraire");
                console.error(e);
            });
        }

        // --- Geolocation ---
        function locateUser() {
            showToast("Recherche de votre position...");
            map.locate({setView: true, maxZoom: 16});
            
            map.on('locationfound', function(e) {
                userLatLng = e.latlng;
                if (userMarker) map.removeLayer(userMarker);
                userMarker = L.marker(e.latlng, { icon: createCustomIcon('user') }).addTo(map)
                    .bindPopup("Vous êtes ici").openPopup();
                showToast("Position trouvée !");
            });

            map.on('locationerror', function(e) {
                showToast("Impossible de vous localiser.");
            });
        }

        // --- Selection & Markers ---
        function selectLocation(place) {
            const lat = parseFloat(place.lat);
            const lon = parseFloat(place.lon);
            lastKnownLocationName = place.display_name;

            document.getElementById('searchResults').classList.add('hidden');
            document.getElementById('searchInput').value = place.name || place.address.road || place.address.city; 
            
            updateDestination(lat, lon, place.name);
        }

        map.on('click', async function(e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            updateDestination(lat, lng, "Position marquée");
            
            // Reverse Geocode pour le nom
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                const data = await response.json();
                const name = data.address.road || data.address.city || "Position marquée";
                lastKnownLocationName = data.display_name;
                if(currentMarker) {
                    currentMarker.setPopupContent(`<div class="text-center"><strong class="block text-sm text-blue-600">${name}</strong></div>`);
                }
            } catch(err) {}
        });

        function updateDestination(lat, lng, title) {
            // UI reset
            if (currentMarker) map.removeLayer(currentMarker);
            if (routingControl) {
                map.removeControl(routingControl); // Reset route si on change de dest
                routingControl = null;
            }

            map.flyTo([lat, lng], 16);
            
            currentMarker = L.marker([lat, lng], { icon: createCustomIcon('pin') }).addTo(map)
                .bindPopup(`<div class="text-center"><strong class="block text-sm mb-1">${title}</strong></div>`)
                .openPopup();
            
            // Afficher le bouton itinéraire
            document.getElementById('routeBtn').classList.remove('hidden');
        }

        // --- UI Helper Functions ---
        function showToast(message) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = message;
            toast.classList.remove('opacity-0', 'pointer-events-none');
            setTimeout(() => toast.classList.add('opacity-0', 'pointer-events-none'), 3000);
        }

        function toggleLayer() {
            isSatellite = !isSatellite;
            if (isSatellite) {
                map.removeLayer(streetLayer);
                satelliteLayer.addTo(map);
            } else {
                map.removeLayer(satelliteLayer);
                streetLayer.addTo(map);
            }
        }

        // --- Search Logic ---
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        const loader = document.getElementById('searchLoader');
        const clearBtn = document.getElementById('clearBtn');
        let debounceTimer;

        searchInput.addEventListener('input', (e) => {
            const query = e.target.value;
            if (query.length > 0) clearBtn.classList.remove('hidden');
            else {
                clearBtn.classList.add('hidden');
                searchResults.classList.add('hidden');
                return;
            }
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => performSearch(query), 500);
        });

        clearBtn.addEventListener('click', () => {
            searchInput.value = '';
            searchResults.classList.add('hidden');
            clearBtn.classList.add('hidden');
        });

        async function performSearch(query) {
            if (query.length < 3) return;
            loader.classList.remove('hidden');
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=5`);
                const data = await response.json();
                displayResults(data);
            } catch (error) {
                showToast("Erreur recherche");
            } finally {
                loader.classList.add('hidden');
            }
        }

        function displayResults(data) {
            searchResults.innerHTML = '';
            if (data.length === 0) {
                searchResults.innerHTML = '<div class="p-4 text-gray-500 text-sm text-center">Aucun résultat</div>';
            } else {
                data.forEach(place => {
                    const item = document.createElement('div');
                    item.className = 'p-3 border-b border-gray-100 hover:bg-blue-50 cursor-pointer transition flex items-start gap-3';
                    item.innerHTML = `
                        <div class="mt-1 text-gray-400"><i class="fas fa-map-marker-alt"></i></div>
                        <div>
                            <div class="font-medium text-gray-800 text-sm">${place.name || place.address.road || "Lieu"}</div>
                            <div class="text-xs text-gray-500 truncate w-64">${place.display_name}</div>
                        </div>`;
                    item.addEventListener('click', () => selectLocation(place));
                    searchResults.appendChild(item);
                });
            }
            searchResults.classList.remove('hidden');
        }

        // --- Gemini AI Logic ---
        function openAiPanel() {
            document.getElementById('aiPanel').classList.remove('panel-closed');
            document.getElementById('aiPanel').classList.add('panel-open');
        }
        function closeAiPanel() {
            document.getElementById('aiPanel').classList.remove('panel-open');
            document.getElementById('aiPanel').classList.add('panel-closed');
        }

        async function askGeminiForGuide() {
            openAiPanel();
            let targetLat, targetLng, contextName = lastKnownLocationName;
            if (currentMarker) {
                targetLat = currentMarker.getLatLng().lat;
                targetLng = currentMarker.getLatLng().lng;
            } else {
                const center = map.getCenter();
                targetLat = center.lat;
                targetLng = center.lng;
                contextName = "la zone affichée";
            }

            document.getElementById('aiEmpty').classList.add('hidden');
            document.getElementById('aiResponse').classList.add('hidden');
            document.getElementById('aiLoader').classList.remove('hidden');
            document.getElementById('aiLoader').classList.add('flex');

            const prompt = `Agis comme un guide touristique local. Coordonnées: ${targetLat}, ${targetLng}. Lieu: ${contextName}. Génère un guide Markdown court en français: 1. Titre. 2. Résumé (2 phrases). 3. Deux lieux à voir. 4. Un resto/café recommandé. Utilise des émojis.`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                
                const text = data.candidates[0].content.parts[0].text;
                document.getElementById('aiResponse').innerHTML = marked.parse(text);
                
                document.getElementById('aiLoader').classList.add('hidden');
                document.getElementById('aiLoader').classList.remove('flex');
                document.getElementById('aiResponse').classList.remove('hidden');
            } catch (error) {
                console.error(error);
                document.getElementById('aiLoader').classList.add('hidden');
                document.getElementById('aiLoader').classList.remove('flex');
                document.getElementById('aiResponse').innerHTML = `<p class="text-red-500 text-center">Erreur AI. Réessayez.</p>`;
                document.getElementById('aiResponse').classList.remove('hidden');
            }
        }
    </script>
</body>
</html>
